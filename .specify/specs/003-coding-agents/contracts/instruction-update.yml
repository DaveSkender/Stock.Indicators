# Instruction File Update Contract

## Purpose

Defines the requirements and constraints for minimal updates to existing scoped instruction files to reference custom GitHub Copilot agents.

## Target Files

```yaml
files:
  - path: ".github/instructions/indicator-series.instructions.md"
    agent: "series"
    current_size: "~185 lines"
    update_size: "+20-25 lines"

  - path: ".github/instructions/indicator-buffer.instructions.md"
    agent: "buffer"
    current_size: "~200 lines"
    update_size: "+20-25 lines"

  - path: ".github/instructions/indicator-stream.instructions.md"
    agent: "streamhub"
    current_size: "~250 lines"
    update_size: "+25-30 lines" # Includes sub-agents
```

## Required Sections

### Section 1: "When to use this agent"

```yaml
section_name: "When to use this agent"
placement: "After YAML frontmatter, before first major heading"
format: |
  ## When to use this agent

  Invoke `@{agent-name}` when you need help with:

  - {Scenario 1}
  - {Scenario 2}
  - {Scenario 3}
  - {Scenario 4}
  - {Scenario 5}

  For comprehensive implementation details, continue reading this document.

constraints:
  line_count: 8-12
  scenarios: 5-7
  tone: "Imperative, action-oriented"
  reference_back: true  # Must link back to current document

example_series:
  content: |
    ## When to use this agent

    Invoke `@series` when you need help with:

    - Implementing new Series indicators from scratch
    - Choosing correct validation patterns and exception types
    - Structuring Series indicator tests
    - Understanding warmup period handling
    - Debugging mathematical accuracy issues

    For comprehensive implementation details, continue reading this document.

example_buffer:
  content: |
    ## When to use this agent

    Invoke `@buffer` when you need help with:

    - Selecting the correct IIncrement interface (Chain/Quote/Pairs)
    - Implementing efficient buffer management patterns
    - Structuring BufferList tests with correct base classes
    - Understanding constructor patterns and chaining syntax
    - Verifying BufferList equivalence with Series results

    For comprehensive implementation details, continue reading this document.

example_streamhub:
  content: |
    ## When to use this agent

    Invoke `@streamhub` when you need help with:

    - Implementing new StreamHub indicators
    - Choosing the correct provider base class (Chain/Quote/Pairs)
    - Deciding between incremental, repaint, and full rebuild patterns
    - Optimizing real-time processing performance
    - Implementing state management and rollback logic
    - Writing comprehensive StreamHub tests with rollback validation
    - Debugging StreamHub issues

    For comprehensive implementation details, continue reading this document.
```

### Section 2: "Related agents"

```yaml
section_name: "Related agents"
placement: "Immediately after 'When to use this agent' section"
format_primary_agents: |  # For series and buffer
  ## Related agents

  For related topics, consult:

  - `@series` - Series indicator development guidance
  - `@buffer` - BufferList indicator development guidance
  - `@streamhub` - StreamHub indicator development guidance

  See also: `.github/agents/{agent-name}.agent.md` for decision trees and quick reference.

format_streamhub: |  # Special format for streamhub with sub-agents
  ## Related agents

  For specialized topics, consult these expert agents:

  - `@streamhub-state` - Deep dive into RollbackState patterns, cache replay strategies, and state restoration after provider history mutations (Insert/Remove)
  - `@streamhub-performance` - Performance optimization techniques, O(1) patterns, RollingWindow utilities, and avoiding O(n²) anti-patterns
  - `@streamhub-testing` - Comprehensive test coverage guidance, test interface selection, rollback validation, and Series parity checks
  - `@streamhub-pairs` - Dual-stream indicator patterns, PairsProvider usage, timestamp synchronization, and dual-cache coordination

  For related indicator styles, see:

  - `@series` - Series indicator development (canonical reference)
  - `@buffer` - BufferList indicator development (incremental processing)

  See also: `.github/agents/stream.agent.md` for decision trees and quick reference.

constraints:
  line_count_primary: 6-10  # Series, buffer
  line_count_streamhub: 12-16  # Includes sub-agents
  agent_references: "All must exist"
  descriptions: "Brief (≤100 characters)"
  self_reference_link: true  # Must link to own agent definition file

example_series:
  content: |
    ## Related agents

    For related topics, consult:

    - `@buffer` - BufferList indicator development guidance
    - `@streamhub` - StreamHub indicator development guidance

    See also: `.github/agents/series.agent.md` for decision trees and quick reference.

example_buffer:
  content: |
    ## Related agents

    For related topics, consult:

    - `@series` - Series indicator development guidance (canonical reference)
    - `@streamhub` - StreamHub indicator development guidance

    See also: `.github/agents/buffer.agent.md` for decision trees and quick reference.

example_streamhub:
  content: |
    ## Related agents

    For specialized topics, consult these expert agents:

    - `@streamhub-state` - Deep dive into RollbackState patterns, cache replay strategies, and state restoration after provider history mutations (Insert/Remove)
    - `@streamhub-performance` - Performance optimization techniques, O(1) patterns, RollingWindow utilities, and avoiding O(n²) anti-patterns
    - `@streamhub-testing` - Comprehensive test coverage guidance, test interface selection, rollback validation, and Series parity checks
    - `@streamhub-pairs` - Dual-stream indicator patterns, PairsProvider usage, timestamp synchronization, and dual-cache coordination

    For related indicator styles, see:

    - `@series` - Series indicator development (canonical reference)
    - `@buffer` - BufferList indicator development (incremental processing)

    See also: `.github/agents/stream.agent.md` for decision trees and quick reference.
```

## Update Constraints

```yaml
minimal_changes:
  description: "Add only the 2 required sections"
  enforcement: "Code review, diff inspection"
  rationale: "Minimize disruption to existing documentation"

backward_compatible:
  description: "Do not modify existing content"
  constraints:
    - No reordering of existing sections
    - No rewording of existing text
    - No changes to code examples
    - No changes to headings or anchors
  enforcement: "Automated diff check"

preserve_frontmatter:
  description: "Keep existing applyTo pattern unchanged"
  example: 'applyTo: "src/**/*.*Series.cs,tests/**/*.*Series.Tests.cs"'
  rationale: "applyTo determines when instructions apply"

total_addition:
  series: "20-25 lines"
  buffer: "20-25 lines"
  streamhub: "25-30 lines"  # Longer due to sub-agents
  enforcement: "Line count check in PR"
```

## Placement Details

```yaml
exact_placement:
  after: "YAML frontmatter (---)"
  before: "First major heading (##)"

  example_before: |
    ---
    applyTo: "src/**/*.*Series.cs,tests/**/*.*Series.Tests.cs"
    description: "Series-style indicator development and testing guidelines"
    ---

    # Series indicator development guidelines

    These instructions apply to series-style indicators...

  example_after: |
    ---
    applyTo: "src/**/*.*Series.cs,tests/**/*.*Series.Tests.cs"
    description: "Series-style indicator development and testing guidelines"
    ---

    ## When to use this agent

    Invoke `@series` when you need help with:

    - Implementing new Series indicators from scratch
    - Choosing correct validation patterns and exception types
    - Structuring Series indicator tests
    - Understanding warmup period handling
    - Debugging mathematical accuracy issues

    For comprehensive implementation details, continue reading this document.

    ## Related agents

    For related topics, consult:

    - `@buffer` - BufferList indicator development guidance
    - `@streamhub` - StreamHub indicator development guidance

    See also: `.github/agents/series.agent.md` for decision trees and quick reference.

    # Series indicator development guidelines

    These instructions apply to series-style indicators...

blank_lines:
  between_frontmatter_and_section: 1
  between_sections: 1
  between_section_and_existing_content: 1
```

## Validation Rules

```yaml
pre_update:
  - [ ] Backup original file
  - [ ] Verify frontmatter preserved
  - [ ] Identify exact insertion point (after frontmatter, before first heading)
  - [ ] Prepare both new sections with correct agent references

post_update:
  - [ ] Verify total addition ≤30 lines
  - [ ] Verify no existing content modified
  - [ ] Verify applyTo pattern unchanged
  - [ ] Verify all agent references exist
  - [ ] Verify markdown linting passes
  - [ ] Verify blank line spacing correct

cross_validation:
  - [ ] Agent definition file references this instruction file
  - [ ] Instruction file references agent definition file
  - [ ] Related agents section matches actual agents
  - [ ] Scenarios in "When to use" align with agent decision trees
```

## Testing Strategy

```yaml
manual_testing:
  - Open instruction file in VS Code
  - Verify sections render correctly
  - Click agent reference links (verify they resolve)
  - Verify "When to use" scenarios match agent capabilities
  - Verify "Related agents" cross-references are bidirectional

automated_testing:
  - markdownlint-cli2 validation
  - Link checker for agent references
  - Diff check to ensure no unintended changes
  - Line count validation (total addition)
  - applyTo pattern validation (unchanged)

developer_validation:
  - Developer reads updated instruction file
  - Developer clicks agent link, reads agent definition
  - Developer invokes agent in Copilot Chat
  - Developer confirms agent guidance aligns with instruction file
```

## Rollback Plan

```yaml
if_issues_found:
  - Revert to original instruction file from backup
  - Document issue in PR comments
  - Fix issue in feature branch
  - Re-apply updates with corrections
  - Re-validate before merge

common_issues:
  - Agent reference link broken (typo in path or agent name)
  - Scenarios don't match agent capabilities (misalignment)
  - Duplicate agent listed in related agents (copy-paste error)
  - Existing content accidentally modified (diff check failure)
```

## Success Criteria

```yaml
per_file:
  - [ ] Exactly 2 new sections added
  - [ ] Total addition ≤30 lines
  - [ ] All existing content unchanged
  - [ ] applyTo pattern preserved
  - [ ] All agent references resolve
  - [ ] markdown linting passes
  - [ ] Blank line spacing correct

cross_file:
  - [ ] All 3 instruction files updated
  - [ ] Agent references bidirectional (agent ↔ instruction)
  - [ ] Consistent formatting across all 3 files
  - [ ] Related agents sections aligned

integration:
  - [ ] Agent definitions reference updated instruction files
  - [ ] Developers can navigate: instruction file → agent → back to instruction
  - [ ] "When to use" scenarios guide appropriate agent invocation
```

## Update Sequence

```yaml
recommended_order:
  1. "Series" # Simplest, establishes pattern
  2. "Buffer" # Similar to series, parallel structure
  3. "StreamHub" # Most complex (includes sub-agents)

rationale:
  - Series and Buffer follow same pattern (no sub-agents)
  - StreamHub requires special handling for sub-agents
  - Easier to catch pattern issues on simpler files first
  - Builds confidence before most complex update
```

## Post-Update Actions

```yaml
after_all_files_updated:
  - Verify agent context file updated (if applicable)
  - Update repository copilot-instructions.md (register new agents)
  - Create PR with all changes
  - Request review focusing on:
    - No unintended content changes
    - Agent references resolve correctly
    - Consistent formatting across files
    - Total additions within budget

pr_description_template: |
  ## Summary

  Add agent reference sections to scoped instruction files for Series, Buffer, and StreamHub agents.

  ## Changes

  - `.github/instructions/indicator-series.instructions.md`: +{n} lines (2 sections)
  - `.github/instructions/indicator-buffer.instructions.md`: +{n} lines (2 sections)
  - `.github/instructions/indicator-stream.instructions.md`: +{n} lines (2 sections)

  ## Sections Added

  1. "When to use this agent" - Scenarios for agent invocation
  2. "Related agents" - Cross-references to related agents

  ## Validation

  - [x] No existing content modified
  - [x] applyTo patterns unchanged
  - [x] All agent references resolve
  - [x] Total additions within budget (≤30 lines per file)
  - [x] markdown linting passes
  - [x] Bidirectional references (agent ↔ instruction)
```
