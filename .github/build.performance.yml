trigger:
  - master

pr:
  - master

pool:
  name: Azure Pipelines
  vmImage: "windows-2019"

steps:
  - task: UseDotNet@2
    displayName: "use .Net Core SDK 3.1.x"
    inputs:
      version: 3.1.x

  - task: DotNetCoreCLI@2
    displayName: "restore packages"
    inputs:
      command: restore
      projects: "**/Tests.Performance.csproj"
      vstsFeed: "5123ca47-74f2-4d67-a5d4-c4d90b8d670a/96cedadb-756b-4db1-8a0d-029c7ed294c7"

  - task: DotNetCoreCLI@2
    displayName: "run benchmarks"
    inputs:
      command: run
      projects: "**/Tests.Performance.csproj"
      arguments: "--configuration Release --no-restore"
      vstsFeed: "5123ca47-74f2-4d67-a5d4-c4d90b8d670a/96cedadb-756b-4db1-8a0d-029c7ed294c7"

  - task: CopyFiles@2
    displayName: "stage artifacts"
    inputs:
      SourceFolder: tests/performance
      Contents: "**/BenchmarkDotNet.Artifacts\results"
      TargetFolder: "$(Build.ArtifactStagingDirectory)"
      CleanTargetFolder: true
      OverWrite: true
      flattenFolders: true

  - task: PublishBuildArtifacts@1
    displayName: "save artifacts"
    inputs:
      ArtifactName: packages
