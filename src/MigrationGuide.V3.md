# v3 Migration Guide (DRAFT IN-PROGRESS)

> This is some rough items that were partly generated by AI, and are still quite difficult to follow.  Improvement needed.

This guide provides a migration path from v2 to v3 of the Stock Indicators library. It includes a summary of all technical changes to the public API, enumerates syntax changes, and provides specific examples of deprecated and breaking changes. Follow the instructions below to update your code to be compatible with the new version.

## Summary of Technical Changes

- **ADXR calculation corrected**: Fixed off-by-one error in ADXR (Average Directional Movement Rating) calculation. ADXR now correctly averages the current ADX with the ADX from exactly `lookbackPeriods` ago (previously used `lookbackPeriods - 1`). This affects all implementation styles (Series, BufferList, StreamHub). ADXR values will differ slightly from previous versions, and the first ADXR will appear one period later.
- All static time-series API method prefixes were renamed from `GetX()` to `ToX()`.
- `Use()` method parameter `candlePart` is now required and no longer defaults to `CandlePart.Close`.
- `Use()` now returns a chainable `QuotePart` instead of a tuple.
- `UlcerIndexResult` property `UI` was renamed to `UlcerIndex`.
- Deprecated 'GetX' tuple interfaces.
- Deprecated internal signals for several indicators.
- `Quote` type was changed to an immutable `record` type.
- `IQuote` interface `Date` property was renamed to `Timestamp`.
- `IQuote` is now a reusable (chainable) type.
- `TQuote` custom quote types now have to implement the `IReusable` interface.
- `IReusableResult` was renamed to `IReusable`.
- `IReusableResult.Value` property was changed to non-nullable and returns `double.NaN` instead of `null`.
- Indicator return types were changed from `sealed class` to immutable `record` types.
- Return type for the `Use()` utility method was renamed from `UseResult` to `QuotePart`.
- `Numerixs` class was renamed to `Numerical`.
- `GetBaseQuote()` indicator and related `BasicData` return types were removed.
- `AtrStopResult` values were changed from `decimal` to `double`.
- `SyncSeries()` utility function and related `SyncType` enum were removed.
- `ToTupleCollection()` utility method was deprecated.
- `Find()` and `FindIndex()` utility methods were removed.
- `SmaAnalysis` result model was renamed to `SmaAnalysisResult` for consistency.

## Exact Syntax Changes

### General Changes

- All static time-series API method prefixes were renamed from `GetX()` to `ToX()`.
- `Use()` method parameter `candlePart` is now required and no longer defaults to `CandlePart.Close`.
- `Use()` now returns a chainable `QuotePart` instead of a tuple.

### Indicator-Specific Changes

- **ADX/ADXR calculation fix**: The ADXR (Average Directional Movement Rating) calculation has been corrected to properly average the current ADX with the ADX from exactly `lookbackPeriods` ago, rather than `lookbackPeriods - 1` periods ago. This mathematical correction affects all three implementation styles (Series, BufferList, StreamHub). As a result:
  - ADXR values will be slightly different from previous versions
  - The first ADXR value appears one period later (e.g., at index 41 instead of 40 for default lookbackPeriods=14)
  - The total count of non-null ADXR values decreases by one
  - This change ensures ADXR correctly follows the standard formula: `ADXR = (Current ADX + ADX from N periods ago) / 2`
- `UlcerIndexResult` property `UI` was renamed to `UlcerIndex`.
- Deprecated 'GetX' tuple interfaces.
- Deprecated internal signals for several indicators.

### Common Breaking Changes

- `Quote` type was changed to an immutable `record` type.
- `IQuote` interface `Date` property was renamed to `Timestamp`.
- `IQuote` is now a reusable (chainable) type.
- `TQuote` custom quote types now have to implement the `IReusable` interface.
- `IReusableResult` was renamed to `IReusable`.
- `IReusableResult.Value` property was changed to non-nullable and returns `double.NaN` instead of `null`.
- Indicator return types were changed from `sealed class` to immutable `record` types.
- Return type for the `Use()` utility method was renamed from `UseResult` to `QuotePart`.
- `Numerixs` class was renamed to `Numerical`.
- `GetBaseQuote()` indicator and related `BasicData` return types were removed.
- `AtrStopResult` values were changed from `decimal` to `double`.
- `SyncSeries()` utility function and related `SyncType` enum were removed.
- `ToTupleCollection()` utility method was deprecated.
- `Find()` and `FindIndex()` utility methods were removed.

## Migration Path

### General Migration Steps

1. Update all static time-series API method prefixes from `GetX()` to `ToX()`.
2. Update `Use()` method calls to include the `candlePart` parameter.
3. Update `Use()` method calls to handle the new `QuotePart` return type.
4. Update `UlcerIndexResult` property `UI` to `UlcerIndex`.
5. Refactor code to remove deprecated 'GetX' tuple interfaces.
6. Refactor code to remove deprecated internal signals for indicators.

### Specific Migration Steps

#### Updating `Quote` Type

1. Change `Quote` type to an immutable `record` type.
2. Rename `IQuote` interface `Date` property to `Timestamp`.
3. Implement the `IReusable` interface for custom `TQuote` types.

#### Updating `IReusableResult`

1. Rename `IReusableResult` to `IReusable`.
2. Update `IReusableResult.Value` property to handle `double.NaN` instead of `null`.

#### Updating Indicator Return Types

1. Change indicator return types from `sealed class` to immutable `record` types.

#### Updating Utility Methods

1. Rename return type for the `Use()` utility method from `UseResult` to `QuotePart`.
2. Rename `Numerixs` class to `Numerical`.
3. Remove `GetBaseQuote()` indicator and related `BasicData` return types.
4. Change `AtrStopResult` values from `decimal` to `double`.
5. Remove `SyncSeries()` utility function and related `SyncType` enum.
6. Deprecate `ToTupleCollection()` utility method.
7. Remove `Find()` and `FindIndex()` utility methods.

## New v3 Feature: Streaming Capabilities

v3 introduces comprehensive **streaming capabilities** for real-time and incremental data processing. Most indicators now support three calculation styles:

### Calculation Styles

#### Series Style (Traditional Batch Processing)

The Series style processes complete historical datasets and returns all results at once. This is the same pattern from v2 and remains the default approach for backtesting and historical analysis.

```csharp
// v2 and v3 Series style
IReadOnlyList<SmaResult> results = quotes.ToSma(20);
```

**Use when:**

- Processing complete historical datasets
- Backtesting strategies
- One-time calculations
- No real-time requirements

#### BufferList Style (Incremental Processing)

The BufferList style allows incremental calculations with efficient buffer management. Use this when you need to add data points incrementally without maintaining a full hub infrastructure.

```csharp
// v3 BufferList style
SmaList smaList = new(20);

foreach (IQuote quote in quotes)  // simulating stream
{
    smaList.Add(quote);
}

IReadOnlyList<SmaResult> results = smaList;
```

**Use when:**

- Growing datasets with frequent appends
- Accumulating historical data
- Incremental calculations without real-time subscriptions
- Memory-efficient processing

#### StreamHub Style (Real-Time Observable Patterns)

The StreamHub style provides real-time processing with observable patterns and state management. Multiple indicators can subscribe to a single `QuoteHub` for coordinated real-time analysis.

```csharp
// v3 StreamHub style
QuoteHub<Quote> quoteHub = new();
SmaHub<Quote> smaHub = quoteHub.ToSma(20);
RsiHub<Quote> rsiHub = quoteHub.ToRsi(14);

foreach (Quote quote in liveQuotes)  // streaming data
{
    quoteHub.Add(quote);
    
    // Access real-time results
    SmaResult smaResult = smaHub.Results.LastOrDefault();
    RsiResult rsiResult = rsiHub.Results.LastOrDefault();
}
```

**Use when:**

- Live data feeds and WebSocket integration
- Multiple indicators need coordinated updates
- Trading applications requiring low latency
- Real-time dashboards and monitoring

### Migration Examples

#### From v2 Series to v3 BufferList

If you were building up results incrementally in v2, you can now use BufferList for better performance:

```csharp
// v2 approach (inefficient for incremental updates)
List<Quote> quotes = new();
foreach (Quote newQuote in stream)
{
    quotes.Add(newQuote);
    var results = quotes.ToSma(20);  // Recalculates everything!
    // Use results...
}

// v3 BufferList (efficient incremental updates)
SmaList smaList = new(20);
foreach (Quote newQuote in stream)
{
    smaList.Add(newQuote);
    SmaResult latest = smaList.LastOrDefault();
    // Use latest...
}
```

#### From v2 Series to v3 StreamHub

If you need to coordinate multiple indicators with live data:

```csharp
// v2 approach (requires maintaining separate lists)
List<Quote> quotes = new();
foreach (Quote newQuote in stream)
{
    quotes.Add(newQuote);
    var smaResults = quotes.ToSma(20);
    var rsiResults = quotes.ToRsi(14);
    var macdResults = quotes.ToMacd();
    // Process results...
}

// v3 StreamHub (coordinated real-time updates)
QuoteHub<Quote> hub = new();
var smaHub = hub.ToSma(20);
var rsiHub = hub.ToRsi(14);
var macdHub = hub.ToMacd();

foreach (Quote newQuote in stream)
{
    hub.Add(newQuote);  // Single update propagates to all observers
    // Access latest results from each hub
}
```

### Performance Considerations

- **Series**: Best throughput for complete datasets, optimized for batch processing
- **BufferList**: Balanced performance for incremental updates, ~10-20% overhead vs Series
- **StreamHub**: Low latency per quote for real-time scenarios, ~20-30% overhead vs Series

### Streaming Documentation

For indicator-specific streaming examples, see the documentation for each indicator. Indicators with streaming support include a "## Streaming" section with BufferList and StreamHub examples.

Popular indicators with complete streaming documentation:

- Moving Averages: [SMA](https://dotnet.stockindicators.dev/indicators/Sma/), [EMA](https://dotnet.stockindicators.dev/indicators/Ema/), [WMA](https://dotnet.stockindicators.dev/indicators/Wma/)
- Oscillators: [RSI](https://dotnet.stockindicators.dev/indicators/Rsi/), [MACD](https://dotnet.stockindicators.dev/indicators/Macd/), [Stochastic](https://dotnet.stockindicators.dev/indicators/Stoch/)
- Channels: [Bollinger Bands](https://dotnet.stockindicators.dev/indicators/BollingerBands/), [Keltner](https://dotnet.stockindicators.dev/indicators/Keltner/)
